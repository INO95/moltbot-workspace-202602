services:
  openclaw-init:
    image: node:20-alpine
    container_name: moltbot-openclaw-init
    user: "0:0"
    volumes:
      - openclaw_main_state:/state-main:rw
      - openclaw_sub1_state:/state-sub1:rw
      - /Users/moltbot/Projects/Moltbot_Workspace/configs/main:/seed-main:ro
      - /Users/moltbot/Projects/Moltbot_Workspace/configs/sub1:/seed-sub1:ro
    command:
      - /bin/sh
      - -lc
      - |
        set -eu
        if [ ! -f /state-main/openclaw.json ] && [ -f /seed-main/openclaw.json ]; then
          cp -r /seed-main/. /state-main/
        fi
        if [ ! -f /state-sub1/openclaw.json ] && [ -f /seed-sub1/openclaw.json ]; then
          cp -r /seed-sub1/. /state-sub1/
        fi
        chown -R 1000:1000 /state-main /state-sub1
    restart: "no"

  prompt-web:
    image: node:20-alpine
    container_name: moltbot-prompt-web
    working_dir: /workspace
    command: [ "npm", "run", "-s", "prompt:web:docker" ]
    volumes:
      - ./:/workspace:rw
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  moltbot-proxy:
    image: nginx:1.27-alpine
    container_name: moltbot-proxy
    depends_on:
      - openclaw-main
      - prompt-web
    volumes:
      - ./docker/nginx/moltbot.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "127.0.0.1:18788:80"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  moltbot-web-proxy:
    image: nginx:1.27-alpine
    container_name: moltbot-web-proxy
    depends_on:
      - prompt-web
    volumes:
      - ./docker/nginx/moltbot-web.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "127.0.0.1:18787:80"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  # 메인 OpenClaw - Telegram 연동
  openclaw-main:
    image: openclaw:local
    container_name: moltbot-main
    depends_on:
      openclaw-init:
        condition: service_completed_successfully
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENCLAW_OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GEMINI_API_KEY: ""
      OPENCLAW_GEMINI_API_KEY: ""
      GOOGLE_API_KEY: ""
      OPENCLAW_GOOGLE_API_KEY: ""
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_USER_ID: ${TELEGRAM_USER_ID}
    volumes:
      - openclaw_main_state:/home/node/.openclaw:rw
      - /Users/moltbot/Projects/Moltbot_Workspace:/home/node/.openclaw/workspace:rw
    ports:
      - "127.0.0.1:18789:18789"
      - "127.0.0.1:18790:18790"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network
    command:
      - /bin/sh
      - -lc
      - |
        if [ -f /home/node/.openclaw/workspace/.env ]; then
          echo "[openclaw-main] workspace/.env must not exist. move secrets to MOLTBOT_ENV_FILE." >&2
          exit 1
        fi
        exec node dist/index.js gateway --bind loopback --port 18789

  # 서브 OpenClaw
  openclaw-sub1:
    image: openclaw:local
    container_name: moltbot-sub1
    depends_on:
      openclaw-init:
        condition: service_completed_successfully
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN_SUB1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENCLAW_OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GEMINI_API_KEY: ""
      OPENCLAW_GEMINI_API_KEY: ""
      GOOGLE_API_KEY: ""
      OPENCLAW_GOOGLE_API_KEY: ""
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN_SUB1:-}
      TELEGRAM_USER_ID: ${TELEGRAM_USER_ID_SUB1:-}
    volumes:
      - openclaw_sub1_state:/home/node/.openclaw:rw
      - /Users/moltbot/Projects/Moltbot_Workspace:/home/node/.openclaw/workspace:rw
    ports:
      - "127.0.0.1:18889:18789"
      - "127.0.0.1:18890:18790"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network
    command:
      - /bin/sh
      - -lc
      - |
        if [ -f /home/node/.openclaw/workspace/.env ]; then
          echo "[openclaw-sub1] workspace/.env must not exist. move secrets to MOLTBOT_ENV_FILE." >&2
          exit 1
        fi
        exec node dist/index.js gateway --bind loopback --port 18789
    profiles:
      - sub

networks:
  moltbot-network:
    driver: bridge

volumes:
  openclaw_main_state:
  openclaw_sub1_state:
