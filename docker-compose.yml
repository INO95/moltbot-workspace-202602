services:
  finance-web:
    image: node:20-alpine
    container_name: moltbot-finance-web
    working_dir: /workspace
    env_file:
      - ./.env
    command: [ "npm", "run", "-s", "finance:web:docker" ]
    volumes:
      - ./:/workspace:rw
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  prompt-web:
    image: node:20-alpine
    container_name: moltbot-prompt-web
    working_dir: /workspace
    command: [ "npm", "run", "-s", "prompt:web:docker" ]
    volumes:
      - ./:/workspace:rw
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  health-web:
    build:
      context: .
      dockerfile: docker/health-web.Dockerfile
    container_name: moltbot-health-web
    working_dir: /workspace
    env_file:
      - ./.env
    command: [ "npm", "run", "-s", "health:web:docker" ]
    volumes:
      - ./:/workspace:rw
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  moltbot-proxy:
    image: nginx:1.27-alpine
    container_name: moltbot-proxy
    depends_on:
      - openclaw-main
      - finance-web
      - prompt-web
      - health-web
    volumes:
      - ./docker/nginx/moltbot.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "127.0.0.1:18788:80"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  moltbot-web-proxy:
    image: nginx:1.27-alpine
    container_name: moltbot-web-proxy
    depends_on:
      - finance-web
      - prompt-web
      - health-web
    volumes:
      - ./docker/nginx/moltbot-web.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "127.0.0.1:18787:80"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network

  # 메인 OpenClaw - Telegram/Gemini 연동
  openclaw-main:
    image: openclaw:local
    container_name: moltbot-main
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENCLAW_OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_USER_ID: ${TELEGRAM_USER_ID}
      OPENCLAW_GOOGLE_API_KEY: ${GEMINI_API_KEY}
      OPENCLAW_GEMINI_API_KEY: ${GEMINI_API_KEY}
    volumes:
      - ./configs/main:/home/node/.openclaw:rw
      - ./:/home/node/.openclaw/workspace:rw
    ports:
      - "18789:18789"
      - "18790:18790"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network
    command: [ "node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789" ]

  # 서브 OpenClaw
  openclaw-sub1:
    image: openclaw:local
    container_name: moltbot-sub1
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN_SUB1}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_API_KEY: ${GEMINI_API_KEY}
    volumes:
      - ./configs/sub1:/home/node/.openclaw:rw
      - ./:/home/node/.openclaw/workspace:rw
    ports:
      - "18889:18789"
      - "18890:18790"
    init: true
    restart: unless-stopped
    networks:
      - moltbot-network
    command: [ "node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789" ]
    profiles:
      - sub

networks:
  moltbot-network:
    driver: bridge
